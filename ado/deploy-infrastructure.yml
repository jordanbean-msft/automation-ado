parameters:
  - name: azureServiceConnection
  - name: resourceGroupName
  - name: environmentName
  - name: pathToInfrastructureDirectory
  - name: adoAccountName
  - name: adoRepositoryName
  - name: pathToRunbooksDirectory
  - name: adoPat

steps:
  - checkout: self
    persistCredentials: true
  - template: print-env.yml
  - task: AzureResourceGroupDeployment@2
    displayName: Deploy Azure Automation account
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      resourceGroupName: ${{ parameters.resourceGroupName }}
      csmFile: ${{ parameters.pathToInfrastructureDirectory }}/main.bicep
      csmParametersFile: ${{ parameters.pathToInfrastructureDirectory }}/env/${{ parameters.environmentName }}.parameters.json
  - task: AzurePowerShell@5
    displayName: Setup Source Control link between Automation Account and Azure DevOps Git repo
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      ScriptType: FilePath
      azurePowerShellVersion: latestVersion
      ScriptPath: setup-source-control-link.ps1
      ScriptArguments: 
        -ResourceGroupName ${{ parameters.resourceGroupName }}
        -AdoAccountName ${{ parameters.adoAccountName }}
        -RepositoryName ${{ parameters.adoRepositoryName }}
        -PathToRunbooks ${{ parameters.pathToRunbooksDirectory }}
        -AdoPat ${{ parameters.adoPat }}